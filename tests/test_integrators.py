import numpy as np
import quflow as qf
import pytest


def get_random_omega_real(N=5, seed=None):
    if seed is not None:
        np.random.seed(seed)
    return np.random.randn(N ** 2)


def get_random_mat(N=5, zero_trace=True, skewh=True):
    W = np.random.randn(N, N) + 1j * np.random.randn(N, N)
    if skewh:
        W -= W.conj().T
    if zero_trace:
        W -= np.eye(N) * np.trace(W) / N
    return W


@pytest.mark.parametrize("N", [5, 16, 61])
def test_compare_isomp_rk4(N):
    np.random.seed(42)
    omega0 = np.random.randn(10)
    W0 = qf.shr2mat(omega0, N=N)
    stepsize = 0.02
    dt = stepsize*qf.hbar(N)
    steps = 500
    Wrk4 = W0.copy()
    Wisomp = W0.copy()
    Wrk4 = qf.integrators.rk4(Wrk4, dt, steps)
    Wisomp = qf.integrators.isomp(Wisomp, dt, steps)

    np.testing.assert_allclose(Wrk4, Wisomp, atol=1e-2, rtol=0)


@pytest.mark.parametrize("use_compsum", [False, True])
@pytest.mark.parametrize("tol", ['auto', 1e-10])
def test_isomp_against_ref(use_compsum, tol):
    W0, Wfinal, stepsize, steps = get_isomp_reference_solution()
    dt = qf.hbar(N=W0.shape[-1])*stepsize

    W = W0.copy()
    W = qf.integrators.isomp(W, dt, steps, compsum=use_compsum, tol=tol)
    np.testing.assert_allclose(W, Wfinal, rtol=0, atol=1e-7)


@pytest.mark.parametrize("tol", ['auto', 1e-10])
def test_isomp_quasinewton_against_ref(tol):
    W0, Wfinal, stepsize, steps = get_isomp_reference_solution()
    dt = qf.hbar(N=W0.shape[-1])*stepsize

    W = W0.copy()
    W = qf.integrators.isomp_quasinewton(W, dt, steps, tol=tol)
    np.testing.assert_allclose(W, Wfinal, rtol=0, atol=1e-7)


def get_isomp_reference_solution():
    stepsize = 0.02
    steps = 500
    W0 = np.array([[0. + 2.36826706e+00j, 0.13588038 + 4.04463666e-03j,
                    -0.07331627 - 1.46998132e-01j, 0.14582599 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [-0.13588038 + 4.04463666e-03j, 0. + 1.33863915e+00j,
                    0.14779024 + 1.29612867e-01j, -0.11821893 - 2.37027366e-01j,
                    0.26086146 - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0.07331627 - 1.46998132e-01j, -0.14779024 + 1.29612867e-01j,
                    0. + 4.76172860e-01j, 0.12974169 + 2.99414794e-01j,
                    -0.15478491 - 3.10341671e-01j, 0.36560511 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [-0.14582599 + 0.00000000e+00j, 0.11821893 - 2.37027366e-01j,
                    -0.12974169 + 2.99414794e-01j, -0. - 2.19131822e-01j,
                    0.09436811 + 4.94638702e-01j, -0.18381361 - 3.68543822e-01j,
                    0.45347733 - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0. + 0.00000000e+00j, -0.26086146 + 0.00000000e+00j,
                    0.15478491 - 3.10341671e-01j, -0.09436811 + 4.94638702e-01j,
                    -0. - 7.47274894e-01j, 0.04795633 + 7.03390500e-01j,
                    -0.20550986 - 4.12044519e-01j, 0.51952355 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.36560511 + 0.00000000e+00j, 0.18381361 - 3.68543822e-01j,
                    -0.04795633 + 7.03390500e-01j, -0. - 1.10825636e+00j,
                    -0.00532925 + 9.16311953e-01j, -0.2199488 - 4.40994397e-01j,
                    0.56042032 - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0.45347733 + 0.00000000e+00j,
                    0.20550986 - 4.12044519e-01j, 0.00532925 + 9.16311953e-01j,
                    -0. - 1.30207621e+00j, -0.0622474 + 1.12507061e+00j,
                    -0.22716214 - 4.55457055e-01j, 0.57425995 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.51952355 + 0.00000000e+00j, 0.2199488 - 4.40994397e-01j,
                    0.0622474 + 1.12507061e+00j, -0. - 1.32873445e+00j,
                    -0.11997495 + 1.32156626e+00j, -0.22716214 - 4.55457055e-01j,
                    0.56042032 - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0.56042032 + 0.00000000e+00j,
                    0.22716214 - 4.55457055e-01j, 0.11997495 + 1.32156626e+00j,
                    -0. - 1.18823107e+00j, -0.17582051 + 1.49733113e+00j,
                    -0.2199488 - 4.40994397e-01j, 0.51952355 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.57425995 + 0.00000000e+00j, 0.22716214 - 4.55457055e-01j,
                    0.17582051 + 1.49733113e+00j, -0. - 8.80566092e-01j,
                    -0.22700125 + 1.64289010e+00j, -0.20550986 - 4.12044519e-01j,
                    0.45347733 - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0. + 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0.56042032 + 0.00000000e+00j,
                    0.2199488 - 4.40994397e-01j, 0.22700125 + 1.64289010e+00j,
                    -0. - 4.05739500e-01j, -0.27039585 + 1.74685892e+00j,
                    -0.18381361 - 3.68543822e-01j, 0.36560511 - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0. + 0.00000000e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.51952355 + 0.00000000e+00j, 0.20550986 - 4.12044519e-01j,
                    0.27039585 + 1.74685892e+00j, 0. + 2.36248703e-01j,
                    -0.30217083 + 1.79438120e+00j, -0.15478491 - 3.10341671e-01j,
                    0.26086146 - 0.00000000e+00j, 0. + 0.00000000e+00j],
                   [0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0.45347733 + 0.00000000e+00j,
                    0.18381361 - 3.68543822e-01j, 0.30217083 + 1.79438120e+00j,
                    0. + 1.04539852e+00j, -0.31705252 + 1.76387986e+00j,
                    -0.11821893 - 2.37027366e-01j, 0.14582599 - 0.00000000e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.36560511 + 0.00000000e+00j, 0.15478491 - 3.10341671e-01j,
                    0.31705252 + 1.76387986e+00j, 0. + 2.02170994e+00j,
                    -0.30650218 + 1.61865496e+00j, -0.07331627 - 1.46998132e-01j],
                   [0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, 0. - 0.00000000e+00j,
                    0. + 0.00000000e+00j, -0.26086146 + 0.00000000e+00j,
                    0.11821893 - 2.37027366e-01j, 0.30650218 + 1.61865496e+00j,
                    0. + 3.16518298e+00j, -0.25204563 + 1.27555639e+00j],
                   [0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    0. - 0.00000000e+00j, 0. + 0.00000000e+00j,
                    -0.14582599 + 0.00000000e+00j, 0.07331627 - 1.46998132e-01j,
                    0.25204563 + 1.27555639e+00j, 0. + 4.47581762e+00j]], dtype=np.complex128)

    Wfinal = np.array([[0.00000000e+00 + 8.80529516e-01j, 8.47997178e-01 - 4.34058797e-01j,
                        -4.98450584e-01 - 2.26289027e-01j, 1.48707398e-01 + 4.23282044e-01j,
                        6.24159359e-02 - 3.01386884e-01j, -1.07231472e-01 + 1.96139615e-01j,
                        8.95306293e-02 - 1.40828453e-01j, -4.57092886e-02 + 1.05477774e-01j,
                        8.07417008e-03 - 7.28714209e-02j, 1.67952393e-02 + 4.63626224e-02j,
                        -2.80601053e-02 - 2.23900533e-02j, 2.87960418e-02 + 3.35899825e-03j,
                        -2.50871039e-02 + 7.60573792e-03j, 1.86894368e-02 - 9.21585912e-03j,
                        -1.09361654e-02 + 5.14491065e-03j, 4.24748326e-03 - 1.35917112e-03j],
                       [-8.47997178e-01 - 4.34058797e-01j, 0.00000000e+00 - 6.68135143e-01j,
                        -1.81251377e-02 - 9.45050593e-01j, -6.77089119e-02 + 4.33315318e-01j,
                        3.65886168e-01 - 4.42064028e-03j, -1.60088190e-01 + 4.05191633e-03j,
                        1.07338679e-01 + 3.79785922e-02j, -9.09547906e-02 - 1.65164579e-02j,
                        5.94026777e-02 + 2.96454632e-03j, -3.51660414e-02 + 8.79450128e-03j,
                        1.61570467e-02 - 1.51065385e-02j, -1.71372628e-03 + 1.63867861e-02j,
                        -6.26617232e-03 - 1.23346978e-02j, 5.49242935e-03 + 8.77629896e-03j,
                        -3.10402098e-03 - 6.01799691e-03j, 1.16278894e-03 + 2.29270323e-03j],
                       [4.98450584e-01 - 2.26289027e-01j, 1.81251377e-02 - 9.45050593e-01j,
                        0.00000000e+00 - 3.89736515e-01j, -3.58344405e-01 - 7.51072003e-01j,
                        1.80419137e-01 + 6.01955991e-01j, 3.41291316e-01 - 1.38874604e-01j,
                        -6.89567287e-02 + 1.52349349e-01j, 1.39406666e-02 - 4.70629684e-02j,
                        -4.46473407e-02 + 5.77365570e-02j, 1.53084673e-02 - 4.99191011e-02j,
                        9.27636402e-04 + 2.90935859e-02j, -1.13381364e-02 - 1.63544727e-02j,
                        1.47943015e-02 + 5.00129626e-03j, -1.08856907e-02 + 5.50144701e-04j,
                        5.30784553e-03 + 3.97240080e-04j, -2.49190846e-03 - 8.51624599e-04j],
                       [-1.48707398e-01 + 4.23282044e-01j, 6.77089119e-02 + 4.33315318e-01j,
                        3.58344405e-01 - 7.51072003e-01j, 0.00000000e+00 - 2.19075827e-01j,
                        -5.93642709e-01 - 4.43868419e-01j, 3.13983618e-01 + 7.60985460e-01j,
                        2.89592945e-01 - 2.59195526e-01j, 3.41431636e-02 + 1.59976191e-01j,
                        -7.19757521e-02 - 8.39663941e-03j, -1.73448822e-03 + 4.07668543e-02j,
                        -2.24008276e-02 - 4.43665346e-02j, 2.75657084e-02 + 8.61498600e-03j,
                        -1.95676699e-02 + 3.39162744e-03j, 1.26116022e-02 - 6.95974051e-03j,
                        -5.38233025e-03 + 5.51238331e-03j, 1.84244272e-03 - 1.37292047e-03j],
                       [-6.24159359e-02 - 3.01386884e-01j, -3.65886168e-01 - 4.42064028e-03j,
                        -1.80419137e-01 + 6.01955991e-01j, 5.93642709e-01 - 4.43868419e-01j,
                        0.00000000e+00 - 1.89465684e-01j, -7.26844734e-01 - 6.92661994e-02j,
                        4.95375401e-01 + 8.85316719e-01j, 1.93182474e-01 - 3.37457128e-01j,
                        1.01237702e-01 + 9.49493313e-02j, -8.40119118e-02 + 6.37697106e-02j,
                        1.58223508e-03 + 1.55169807e-02j, -3.05978023e-02 - 2.72195774e-02j,
                        2.73323788e-02 - 1.45470550e-02j, -1.31549626e-02 + 1.48758745e-02j,
                        8.38611194e-03 - 7.66057177e-03j, -2.65276944e-03 + 3.21688217e-03j],
                       [1.07231472e-01 + 1.96139615e-01j, 1.60088190e-01 + 4.05191633e-03j,
                        -3.41291316e-01 - 1.38874604e-01j, -3.13983618e-01 + 7.60985460e-01j,
                        7.26844734e-01 - 6.92661994e-02j, 0.00000000e+00 - 1.16772114e-01j,
                        -7.89907898e-01 + 3.24256031e-01j, 6.91686408e-01 + 9.57440400e-01j,
                        9.35572733e-02 - 3.56494883e-01j, 1.12143792e-01 + 1.67942643e-02j,
                        -5.25598650e-02 + 1.17227923e-01j, -6.84132844e-03 + 4.21391548e-03j,
                        -2.68785518e-02 - 1.69492430e-02j, 1.75036067e-02 - 2.23937259e-02j,
                        -8.23872554e-03 + 1.32840514e-02j, 6.69341916e-03 - 3.65066683e-03j],
                       [-8.95306293e-02 - 1.40828453e-01j, -1.07338679e-01 + 3.79785922e-02j,
                        6.89567287e-02 + 1.52349349e-01j, -2.89592945e-01 - 2.59195526e-01j,
                        -4.95375401e-01 + 8.85316719e-01j, 7.89907898e-01 + 3.24256031e-01j,
                        0.00000000e+00 - 8.77622105e-03j, -8.11653619e-01 + 7.17111464e-01j,
                        8.63784418e-01 + 9.72470957e-01j, 9.44808175e-03 - 3.49881913e-01j,
                        8.74697470e-02 - 3.54524265e-02j, -6.80777619e-03 + 1.44725415e-01j,
                        -1.10279829e-02 - 1.28129445e-03j, -2.50617129e-02 - 1.79004909e-02j,
                        7.79867023e-03 - 9.88273479e-03j, -1.66032571e-03 + 2.70908220e-03j],
                       [4.57092886e-02 + 1.05477774e-01j, 9.09547906e-02 - 1.65164579e-02j,
                        -1.39406666e-02 - 4.70629684e-02j, -3.41431636e-02 + 1.59976191e-01j,
                        -1.93182474e-01 - 3.37457128e-01j, -6.91686408e-01 + 9.57440400e-01j,
                        8.11653619e-01 + 7.17111464e-01j, 0.00000000e+00 + 1.13310098e-01j,
                        -7.85856928e-01 + 1.10255112e+00j, 9.88001666e-01 + 9.39312122e-01j,
                        -6.30794630e-02 - 3.31478214e-01j, 5.39931433e-02 - 5.96086279e-02j,
                        3.47174265e-02 + 1.52012410e-01j, -8.62029409e-03 - 2.58835014e-03j,
                        -2.42898243e-02 - 2.52912497e-02j, 5.16107492e-04 + 6.25536822e-03j],
                       [-8.07417008e-03 - 7.28714209e-02j, -5.94026777e-02 + 2.96454632e-03j,
                        4.46473407e-02 + 5.77365570e-02j, 7.19757521e-02 - 8.39663941e-03j,
                        -1.01237702e-01 + 9.49493313e-02j, -9.35572733e-02 - 3.56494883e-01j,
                        -8.63784418e-01 + 9.72470957e-01j, 7.85856928e-01 + 1.10255112e+00j,
                        0.00000000e+00 + 2.43816850e-01j, -7.14733427e-01 + 1.45444629e+00j,
                        1.05379778e+00 + 8.69384572e-01j, -1.36417926e-01 - 2.99537907e-01j,
                        3.76730291e-02 - 5.87355362e-02j, 6.86227541e-02 + 1.36549131e-01j,
                        -1.82284317e-02 - 1.40262266e-02j, -1.38392876e-02 - 7.33142738e-03j],
                       [-1.67952393e-02 + 4.63626224e-02j, 3.51660414e-02 + 8.79450128e-03j,
                        -1.53084673e-02 - 4.99191011e-02j, 1.73448822e-03 + 4.07668543e-02j,
                        8.40119118e-02 + 6.37697106e-02j, -1.12143792e-01 + 1.67942643e-02j,
                        -9.44808175e-03 - 3.49881913e-01j, -9.88001666e-01 + 9.39312122e-01j,
                        7.14733427e-01 + 1.45444629e+00j, 0.00000000e+00 + 3.93424228e-01j,
                        -6.07275742e-01 + 1.75094825e+00j, 1.06849336e+00 + 7.64020993e-01j,
                        -2.14802588e-01 - 2.53482978e-01j, 3.57646391e-02 - 3.97183740e-02j,
                        9.69655637e-02 + 1.04827331e-01j, -3.25913325e-02 - 2.63369615e-02j],
                       [2.80601053e-02 - 2.23900533e-02j, -1.61570467e-02 - 1.51065385e-02j,
                        -9.27636402e-04 + 2.90935859e-02j, 2.24008276e-02 - 4.43665346e-02j,
                        -1.58223508e-03 + 1.55169807e-02j, 5.25598650e-02 + 1.17227923e-01j,
                        -8.74697470e-02 - 3.54524265e-02j, 6.30794630e-02 - 3.31478214e-01j,
                        -1.05379778e+00 + 8.69384572e-01j, 6.07275742e-01 + 1.75094825e+00j,
                        0.00000000e+00 + 5.64739380e-01j, -4.72580546e-01 + 1.96757910e+00j,
                        1.01817504e+00 + 6.40833687e-01j, -2.82820730e-01 - 1.91211457e-01j,
                        7.85760006e-02 - 1.84553135e-02j, 5.39654120e-02 + 4.41918649e-02j],
                       [-2.87960418e-02 + 3.35899825e-03j, 1.71372628e-03 + 1.63867861e-02j,
                        1.13381364e-02 - 1.63544727e-02j, -2.75657084e-02 + 8.61498600e-03j,
                        3.05978023e-02 - 2.72195774e-02j, 6.84132844e-03 + 4.21391548e-03j,
                        6.80777619e-03 + 1.44725415e-01j, -5.39931433e-02 - 5.96086279e-02j,
                        1.36417926e-01 - 2.99537907e-01j, -1.06849336e+00 + 7.64020993e-01j,
                        4.72580546e-01 + 1.96757910e+00j, 0.00000000e+00 + 7.85959887e-01j,
                        -3.10342058e-01 + 2.06732160e+00j, 9.04181357e-01 + 4.94429985e-01j,
                        -3.43647097e-01 - 9.83921127e-02j, 1.37067754e-01 - 1.37132748e-02j],
                       [2.50871039e-02 + 7.60573792e-03j, 6.26617232e-03 - 1.23346978e-02j,
                        -1.47943015e-02 + 5.00129626e-03j, 1.95676699e-02 + 3.39162744e-03j,
                        -2.73323788e-02 - 1.45470550e-02j, 2.68785518e-02 - 1.69492430e-02j,
                        1.10279829e-02 - 1.28129445e-03j, -3.47174265e-02 + 1.52012410e-01j,
                        -3.76730291e-02 - 5.87355362e-02j, 2.14802588e-01 - 2.53482978e-01j,
                        -1.01817504e+00 + 6.40833687e-01j, 3.10342058e-01 + 2.06732160e+00j,
                        0.00000000e+00 + 1.05601168e+00j, -1.25707683e-01 + 2.01929855e+00j,
                        6.66150389e-01 + 3.85987358e-01j, -2.38875281e-01 - 4.23026856e-02j],
                       [-1.86894368e-02 - 9.21585912e-03j, -5.49242935e-03 + 8.77629896e-03j,
                        1.08856907e-02 + 5.50144701e-04j, -1.26116022e-02 - 6.95974051e-03j,
                        1.31549626e-02 + 1.48758745e-02j, -1.75036067e-02 - 2.23937259e-02j,
                        2.50617129e-02 - 1.79004909e-02j, 8.62029409e-03 - 2.58835014e-03j,
                        -6.86227541e-02 + 1.36549131e-01j, -3.57646391e-02 - 3.97183740e-02j,
                        2.82820730e-01 - 1.91211457e-01j, -9.04181357e-01 + 4.94429985e-01j,
                        1.25707683e-01 + 2.01929855e+00j, 0.00000000e+00 + 1.45791163e+00j,
                        1.14660797e-01 + 1.65352366e+00j, 2.67074603e-01 + 3.81331646e-01j],
                       [1.09361654e-02 + 5.14491065e-03j, 3.10402098e-03 - 6.01799691e-03j,
                        -5.30784553e-03 + 3.97240080e-04j, 5.38233025e-03 + 5.51238331e-03j,
                        -8.38611194e-03 - 7.66057177e-03j, 8.23872554e-03 + 1.32840514e-02j,
                        -7.79867023e-03 - 9.88273479e-03j, 2.42898243e-02 - 2.52912497e-02j,
                        1.82284317e-02 - 1.40262266e-02j, -9.69655637e-02 + 1.04827331e-01j,
                        -7.85760006e-02 - 1.84553135e-02j, 3.43647097e-01 - 9.83921127e-02j,
                        -6.66150389e-01 + 3.85987358e-01j, -1.14660797e-01 + 1.65352366e+00j,
                        0.00000000e+00 + 1.98167686e+00j, 2.72704961e-01 + 1.12290117e+00j],
                       [-4.24748326e-03 - 1.35917112e-03j, -1.16278894e-03 + 2.29270323e-03j,
                        2.49190846e-03 - 8.51624599e-04j, -1.84244272e-03 - 1.37292047e-03j,
                        2.65276944e-03 + 3.21688217e-03j, -6.69341916e-03 - 3.65066683e-03j,
                        1.66032571e-03 + 2.70908220e-03j, -5.16107492e-04 + 6.25536822e-03j,
                        1.38392876e-02 - 7.33142738e-03j, 3.25913325e-02 - 2.63369615e-02j,
                        -5.39654120e-02 + 4.41918649e-02j, -1.37067754e-01 - 1.37132748e-02j,
                        2.38875281e-01 - 4.23026856e-02j, -2.67074603e-01 + 3.81331646e-01j,
                        -2.72704961e-01 + 1.12290117e+00j, 0.00000000e+00 + 2.06200782e+00j]], dtype=np.complex128)

    return W0, Wfinal, stepsize, steps
